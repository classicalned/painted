<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haunted Painting – Display</title>
<style>
  html,body{margin:0;height:100%;background:#111;}
  #stage{position:relative; width:100vw; height:100vh; overflow:hidden; background:#111;}
  .layer{position:absolute; inset:0; background-size:cover; background-position:center; opacity:0; transition:opacity 600ms ease;}
  .show{opacity:1;}
  #pre{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#888;font:16px system-ui}
</style>
</head>
<body>
<div id="stage">
  <div id="bg" class="layer"></div>
  <div id="pos" class="layer"></div>
  <div id="final" class="layer"></div>
  <div id="pre">Loading…</div>
</div>

<!-- Firebase (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
/*** 1) EDIT THESE: your Firebase project + a simple room ID ***/
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_APP.firebaseapp.com",
  databaseURL: "https://YOUR_APP-default-rtdb.firebaseio.com",
  projectId: "YOUR_APP",
  storageBucket: "YOUR_APP.appspot.com",
  messagingSenderId: "000000000000",
  appId: "1:000000000000:web:XXXXXXXX"
};
const ROOM_ID = "house01"; // change per routine if needed
/*** END EDITS ***/

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ref = db.ref("rooms/"+ROOM_ID);

const stage = document.getElementById('stage');
const bg = document.getElementById('bg');
const pos = document.getElementById('pos');
const fin = document.getElementById('final');
const pre = document.getElementById('pre');

const ASSETS = {
  bg: "assets/bg/house_plate.jpg",
  pos: ["pos1.png","pos2.png","pos3.png","pos4.png","pos5.png"]
       .map(p => `assets/subject/${p}`)
};

let state = { step:0, card:"AH" };
let loaded = new Set();

function preload(src){ return new Promise(res=>{
  const i = new Image(); i.onload=()=>res(src); i.onerror=()=>res(src); i.src=src;
});}

async function init(){
  const toLoad = [ASSETS.bg, ...ASSETS.pos];
  await Promise.all(toLoad.map(preload));
  bg.style.backgroundImage = `url(${ASSETS.bg})`;
  bg.classList.add('show'); // background always visible
  pre.remove();

  // subscribe to realtime state
  ref.on('value', snap=>{
    const v = snap.val(); if(!v) return;
    const nextStep = Number(v.step||0);
    const nextCard = (v.card||"AH").toUpperCase();
    render(nextStep, nextCard);
  });
}

let currentStep = -1;
function render(step, card){
  if(step===currentStep) return;
  currentStep = step;

  // clear layers
  pos.classList.remove('show');
  fin.classList.remove('show');

  if(step<=4){
    pos.style.backgroundImage = `url(${ASSETS.pos[step]})`;
    // tiny timeout ensures CSS transition
    requestAnimationFrame(()=>pos.classList.add('show'));
  } else {
    const finalSrc = `assets/finals/${card}.png`; // pre-rendered final
    // Preload once per card
    if(!loaded.has(finalSrc)){ preload(finalSrc).then(()=>loaded.add(finalSrc)); }
    fin.style.backgroundImage = `url(${finalSrc})`;
    requestAnimationFrame(()=>fin.classList.add('show'));
  }
}

init();
</script>
</body>
</html>
