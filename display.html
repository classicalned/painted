<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haunted Painting – Display</title>
<style>
  html,body{margin:0;height:100%;background:#111;}
  #stage{position:relative; width:100vw; height:100vh; overflow:hidden; background:#111;}
  .layer{
    position:absolute; inset:0;
    background-size:cover; background-position:center;
    opacity:0; transition:opacity 1500ms ease;
  }
  .show{opacity:1;}
  #pre{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#888;font:16px system-ui}
</style>
</head>
<body>
<div id="stage">
  <div id="bg"   class="layer"></div>
  <div id="posA" class="layer"></div><!-- alt layer A -->
  <div id="posB" class="layer"></div><!-- alt layer B -->
  <div id="final" class="layer"></div>
  <div id="pre">Loading…</div>
</div>

<!-- Firebase (compat SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ✅ Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA-qhu_bH-GSKrWwAeUUmuxh5EbSrGgOrE",
  authDomain: "haunted-painting.firebaseapp.com",
  databaseURL: "https://haunted-painting-default-rtdb.firebaseio.com",
  projectId: "haunted-painting",
  storageBucket: "haunted-painting.firebasestorage.app",
  messagingSenderId: "543448897329",
  appId: "1:543448897329:web:548f8e73300484977ec210",
  measurementId: "G-4WTEQ9TRYD"
};

firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const ref = db.ref("rooms/house01");

// DOM
const bg   = document.getElementById('bg');
const posA = document.getElementById('posA');
const posB = document.getElementById('posB');
const fin  = document.getElementById('final');
const pre  = document.getElementById('pre');

// Assets
const ASSETS = {
  bg: "assets/bg/house_plate.jpg",
  pos: ["pos1.png","pos2.png","pos3.png","pos4.png","pos5.png","pos6.png"].map(p=>"assets/subject/"+p)
  // finals loaded at runtime: assets/finals/{CARD}.png
};

let loaded = new Set();
function preload(src){ return new Promise(res=>{ const i=new Image(); i.onload=()=>res(src); i.onerror=()=>res(src); i.src=src; }); }

async function init(){
  const toLoad = [ASSETS.bg, ...ASSETS.pos];
  await Promise.all(toLoad.map(preload));
  bg.style.backgroundImage = `url(${ASSETS.bg})`;
  bg.classList.add('show');
  pre.remove();

  ref.on('value', snap=>{
    const v = snap.val(); if(!v) return;
    render(Number(v.step||0), (v.card||"AH").toUpperCase());
  });
}

// crossfade state
let currentStep = -1;
let active = 'A'; // which pos layer is currently showing ('A' or 'B')

// helper: swap visibility between two layers with a crossfade
function crossfade(nextLayer, nextImage, prevLayer){
  // keep previous visible during the fade
  if(prevLayer) prevLayer.classList.add('show');

  // set next image and fade it in
  nextLayer.style.backgroundImage = `url(${nextImage})`;
  requestAnimationFrame(()=>{
    nextLayer.classList.add('show');
    const done = ()=> {
      if(prevLayer) prevLayer.classList.remove('show'); // hide the old one after fade
      nextLayer.removeEventListener('transitionend', done);
    };
    nextLayer.addEventListener('transitionend', done);
  });
}

function render(step, card){
  if(step === currentStep) return;
  currentStep = step;

  // always hide final unless we're on final frame
  fin.classList.remove('show');

  if(step <= 5){
    // choose which pos layer is incoming/outgoing
    const incoming = (active === 'A') ? posB : posA;
    const outgoing = (active === 'A') ? posA : posB;

    crossfade(incoming, ASSETS.pos[step], outgoing);

    // flip active for next step
    active = (active === 'A') ? 'B' : 'A';

  } else {
    // final card crossfades over whichever pos layer is currently visible
    const finalSrc = `assets/finals/${card}.png`;
    if(!loaded.has(finalSrc)){ preload(finalSrc).then(()=>loaded.add(finalSrc)); }
    fin.style.backgroundImage = `url(${finalSrc})`;
    requestAnimationFrame(()=> fin.classList.add('show'));
  }
}

init();
</script>
</body>
</html>
